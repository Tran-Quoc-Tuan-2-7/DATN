@{
    ViewData["Title"] = "Thống kê";
}

<h3>Thống kê</h3>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center shadow-sm">
            <div class="card-body">
                <p class="card-title">Sản phẩm</p>
                <h4>@ViewBag.CountProduct</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center shadow-sm">
            <div class="card-body">
                <p class="card-title">Đơn hàng</p>
                <h4>@ViewBag.CountOrder</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center shadow-sm">
            <div class="card-body">
                <p class="card-title">Danh mục</p>
                <h4>@ViewBag.CountCategory</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center shadow-sm">
            <div class="card-body">
                <p class="card-title">Người dùng</p>
                <h4>@ViewBag.CountUser</h4>
            </div>
        </div>
    </div>
</div>

<div class="container mb-4">
    <div class="row">
        <div class="col-md-3">
            <label for="filterDays">Chọn thời gian:</label>
            <select class="form-select filter-select" id="filterDays">
                <option value="30">---Lọc dữ liệu---</option>
                <option value="7">7 ngày trước</option>
                <option value="30">1 tháng qua</option>
                <option value="90">3 tháng qua</option>
                <option value="365">1 năm</option>
            </select>
        </div>
        <div class="col-md-3">
            <label for="storeSelect">Chọn cửa hàng:</label>
            <select class="form-select" id="storeSelect">
                <option value="0">Tất cả cửa hàng</option>
                @foreach (var store in ViewBag.Stores)
                {
                    <option value="@store.Id">@store.Name</option>
                }
            </select>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <h5>Biểu đồ thống kê doanh số</h5>
        <div id="myfirstchart" style="height: 300px;"></div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var ChartMorris = new Morris.Line({
                element: 'myfirstchart',
                data: [],
                xkey: 'date',
                ykeys: ['sold', 'quantity', 'revenue', 'profit'],
                labels: [ 'Số lượng', 'Đơn hàng', 'Doanh thu', 'Lợi nhuận'],
                parseTime: false,
                xLabelAngle: 45
            });

            function loadChartData(startDate, endDate, storeId) {
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("GetChartDataBySelect", "Dashboard")',
                    dataType: "json",
                    data: {
                        startDate: startDate,
                        endDate: endDate,
                        storeId: storeId
                    },
                    success: function (data) {
                        if (data && data.length > 0) {
                            ChartMorris.setData(data.map(function (item) {
                                return {
                                    date: item.date,
                                    sold: item.sold,
                                    quantity: item.quantity,
                                    revenue: item.revenue,
                                    profit: item.profit
                                };
                            }));
                        } else {
                            console.warn("Không có dữ liệu để hiển thị.");
                            ChartMorris.setData([]);
                        }
                    },
                    error: function (error) {
                        console.error("Lỗi khi lấy dữ liệu biểu đồ:", error);
                    }
                });
            }

            // Load mặc định toàn bộ dữ liệu
            loadChartData("2000-01-01", new Date().toISOString().split('T')[0], 0);

            // Khi thay đổi bộ lọc
            $('#filterDays, #storeSelect').on('change', function () {
                var days = parseInt($('#filterDays').val());
                var storeId = parseInt($('#storeSelect').val());

                var endDate = new Date();
                var startDate = new Date(endDate.getTime() - (days * 24 * 60 * 60 * 1000));

                loadChartData(startDate.toISOString().split('T')[0], endDate.toISOString().split('T')[0], storeId);
            });
        });
    </script>
}
